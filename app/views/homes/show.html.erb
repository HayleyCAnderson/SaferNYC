<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.0/leaflet-heat.js'></script>
<nav id="menu" class="menu"></nav>
<div id="map"></div>

<script>
  L.mapbox.accessToken = "<%= ENV['mapbox_access_token'] %>";
  var map = L.mapbox.map("map", "<%= ENV['mapbox_map_id'] %>")
    .setView([40.7496821, -73.9704147], 14);

  var layers = document.getElementById("menu");

  var markers = L.mapbox.featureLayer(<%= @marker_data_set.html_safe %>);

  // var heatmap = L.mapbox.featureLayer(<%= @marker_data_set.html_safe %>).on("ready", function() {
  //   layer.eachLayer(function(l) {
  //     L.heatLayer([], { maxZoom: 11 }).addLatLng(l.getLatLng());
  //   });
  // });

  var heat = L.heatLayer([], {maxZoom: 11});
  var heatmapLayer = L.mapbox.featureLayer(<%= @marker_data_set["geometry"]["coordinates"] %>).on('ready', function() {
    heatmapLayer.eachLayer(function(l) {
      heat.addLatLng(l.getLatLng());
    });
  });

  // var heat = L.heatLayer(<%= @marker_data_set.html_safe %>.geometry.coordinates, {radius: 25});

  addLayer(markers, "Data View", 1, "active");
  addLayer(heatmapLayer, "Heatmap", 2, "");

  function addLayer(layer, name, zIndex, default_class) {
    layer
      .setZIndex(zIndex)
      .addTo(map);

    var link = document.createElement("a");
      link.href = "#";
      link.className = default_class;
      link.innerHTML = name;

    link.onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();

      $.each(layers, function(i, layer) {
        this.className = "";
      });

      map.addLayer(layer);
      link.className = "active";
    };

    layers.appendChild(link);
  }
</script>
